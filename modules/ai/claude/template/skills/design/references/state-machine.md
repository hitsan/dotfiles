# State Machine Design

## Overview

対話形式で段階的にステートマシンを設計し、ASCII形式の状態遷移図と遷移表を作成する。ユーザーに質問しながら、状態・イベント・遷移条件を明確化し、エッジケースを検出する。設計完了後、実装は行わず設計図の提示で完了する。

## Design Workflow

### Step 1: 要件のヒアリング

AskUserQuestion ツールを使用して、以下を確認する:

1. **設計対象の機能・システムの概要**
   - 何を実装したいか？
   - 既存コードの設計か、新規機能の設計か？

2. **想定されるユースケース**
   - 主要なユーザー操作やシナリオは？
   - どのような流れで機能が使われるか？

**質問例:**
- 「この機能は、どのような状態を持ちますか？（例: ログイン前/ログイン中/ログイン済み）」
- 「ユーザーや外部システムからのどのようなアクションを想定していますか？」
- 「どのような条件で状態が変化しますか？」

### Step 2: 状態とイベントの抽出

ヒアリング内容から、以下を抽出して整理する:

**状態リスト:**
- システムが取りうる離散的な状態を列挙
- 各状態の意味を簡潔に説明

**イベント/アクションリスト:**
- 状態を変化させるトリガーを列挙
- 外部イベント（ユーザー操作、API呼び出し）と内部イベント（タイマー、条件達成）を区別

ユーザーに提示し、不足や曖昧な点を AskUserQuestion で確認する。

### Step 3: 状態遷移の定義

各状態からの遷移を定義する。以下の形式で整理:

**状態遷移表（マークダウンテーブル）:**

| 現在の状態 | イベント | 次の状態 | 遷移条件 | アクション |
|------------|----------|----------|----------|------------|
| 状態A | イベント1 | 状態B | 条件X | 処理α |
| 状態A | イベント2 | 状態C | - | 処理β |

- **遷移条件**: 遷移が発生するための前提条件（ガード条件）
- **アクション**: 遷移時に実行される処理

不明確な遷移や未定義のケースについて、AskUserQuestion で確認する。

### Step 4: ASCII状態遷移図の作成

テキストベースのASCII図で状態遷移を視覚化する:

**基本形式:**
```
    +-----------------+  event1  +-----------------+
    |   State A       |--------->|   State B       |
    +-----------------+          +-----------------+
         |                            |
         | event2                     | event3
         | [condition]                |
         v                            v
    +-----------------+          +-----------------+
    |   State C       |          |   State D       |
    +-----------------+          +-----------------+
         |                            |
         +-------------+--------------+
                       |
                  event4
                       |
                       v
                  +---------+
                  |   End   |
                  +---------+
```

**記法:**
- `+-------+`: 状態を表すボックス
- `------>`: 状態遷移の矢印
- `event`: 遷移を引き起こすイベント
- `[condition]`: 遷移条件（ガード）
- `/ action`: 遷移時に実行されるアクション

**複数の遷移先がある場合:**
```
    +-----------------+
    |   State A       |
    +-----------------+
         |      |
   event1|      | event2
    [ok] |      | [error]
         v      v
    +-----+  +-------+
    |State|  |State  |
    |  B  |  |Error  |
    +-----+  +-------+
```

### Step 5: エッジケースの検証

設計した状態遷移に対して、以下を検証し、ユーザーに確認する:

1. **到達不能な状態**: 初期状態からどの遷移を辿っても到達できない状態
2. **デッドロック**: 終了状態に到達できない状態
3. **未定義の遷移**: 各状態で発生しうるイベントの処理が定義されているか
4. **競合状態**: 同時に複数イベントが発生した場合の優先順位
5. **異常系**: エラーやタイムアウト時の振る舞い

不足があれば、AskUserQuestion で方針を確認し、設計を修正する。

### Step 6: 設計成果物の提示

最終的な設計成果物を提示する:

1. **設計概要**
   - 対象機能の説明
   - 設計の前提条件

2. **状態リスト**
   - 全状態の一覧と説明

3. **イベントリスト**
   - 全イベントの一覧と説明

4. **ASCII状態遷移図**
   - テキストベースの視覚的な状態遷移の全体像

5. **状態遷移表**
   - 詳細な遷移ルールの一覧

6. **エッジケースと検証結果**
   - 確認したエッジケースと対応方針

7. **実装時の考慮事項**
   - 推奨される実装パターン（State パターン、有限状態機械ライブラリなど）
   - テスト観点（各遷移パス、異常系、エッジケース）

## Important Notes

- **設計のみで完了**: このスキルは設計図の作成で完了し、実装コードは書かない
- **対話重視**: 曖昧な点は必ず AskUserQuestion で確認し、推測で進めない
- **段階的な設計**: 一度にすべてを決めず、ユーザーと対話しながら段階的に設計を固める
- **ASCII図優先**: 複雑な遷移もASCII図で視覚化し、ターミナルで表示可能にする
