---
name: design
description: 要件に応じて最適な設計手法（データフローorステートマシン）を選択し、設計を支援する。新機能・仕様検討時に手動起動（/design）で使用。実装は行わず、設計のみで完了する。
---

# Design

## Overview

ユーザーの要件をヒアリングし、以下のいずれかの設計手法を選択・実行する：

1. **データフロー設計**: データ変換・パイプライン処理
2. **ステートマシン設計**: 状態管理・振る舞いの設計
3. **複合設計**: 両方を組み合わせた設計

実装コードは書かず、設計図の提示で完了する。

## Workflow

### Step 1: 要件の初期ヒアリング

AskUserQuestion ツールで以下を確認：

**質問例:**
- 「どのような機能・システムを設計したいですか？」
- 「主な関心事は何ですか？」
  - データの変換・加工・フロー
  - システムの状態・振る舞い・ユーザーフロー
  - 両方

### Step 2: 設計手法の判断

要件から適切な手法を判断する。詳細は `references/method-selection.md` を参照。

#### データフロー設計を選択する場合

以下のいずれかに該当する場合：
- API連携、ETL処理、データパイプライン
- 「入力 → 処理 → 出力」の流れが明確
- データ変換・集計・フィルタリングが中心
- 関数型プログラミングの文脈

**例:**
- 「APIから取得したデータをフィルタして集計したい」
- 「CSVファイルを読み込んでJSONに変換したい」
- 「複数のデータソースをマージして出力したい」

→ **`references/dataflow.md` のワークフローを実行**

#### ステートマシン設計を選択する場合

以下のいずれかに該当する場合：
- ユーザーフロー、UI状態管理
- イベント駆動の振る舞い
- 「状態 → イベント → 次の状態」の関係が重要
- プロトコル、ワークフロー、ライフサイクル管理

**例:**
- 「ログイン機能の状態遷移を設計したい」
- 「注文処理のワークフローを明確にしたい」
- 「接続状態の管理ロジックを設計したい」

→ **`references/state-machine.md` のワークフローを実行**

#### 複合設計が必要な場合

両方の側面が重要な場合（例: データ処理を含む状態管理）：

**例:**
- 「ファイルアップロード機能（状態遷移 + データ処理）」
- 「リアルタイムデータ処理パイプライン（データフロー + 状態管理）」
- 「非同期ジョブシステム（状態遷移 + データ変換）」

**アプローチ:**
1. 主要な側面を先に設計（通常は状態遷移）
2. もう一方の側面を補完的に設計
3. 両者の整合性を確認し、統合ガイドを提示

### Step 3: 選択した手法の実行

判断した手法に応じて、該当するワークフローを実行する。

**データフロー設計:**
`references/dataflow.md` の Design Workflow に従って設計を進める。

**ステートマシン設計:**
`references/state-machine.md` の Design Workflow に従って設計を進める。

**複合設計:**
1. ステートマシン設計を先に実行（全体の状態と遷移を明確化）
2. 各状態や遷移で必要なデータフロー設計を実行
3. 両方の設計図を統合して提示

### Step 4: 設計成果物の提示

選択した手法に応じた成果物を提示する。

**データフロー設計の場合:**
1. 設計概要
2. データ構造定義（入力・中間・出力）
3. データフロー図（Mermaid/ASCII）
4. 変換ステップ詳細表
5. エッジケースと対応方針
6. 実装時の考慮事項

**ステートマシン設計の場合:**
1. 設計概要
2. 状態リスト
3. イベントリスト
4. ASCII状態遷移図
5. 状態遷移表
6. エッジケースと検証結果
7. 実装時の考慮事項

**複合設計の場合:**
- 上記両方の成果物
- 統合ガイド（状態とデータフローの対応関係）

## Important Notes

- **手法選択を明示**: 選択した設計手法とその理由をユーザーに伝える
- **柔軟な切り替え**: 途中で手法が不適切と判明した場合は切り替える
- **設計のみで完了**: 実装コードは書かない
- **対話重視**: 曖昧な点は必ず AskUserQuestion で確認し、推測で進めない
- **段階的な設計**: 一度にすべてを決めず、ユーザーと対話しながら段階的に設計を固める

## References

- `references/method-selection.md`: 設計手法の選択基準詳細
- `references/dataflow.md`: データフロー設計ワークフロー
- `references/state-machine.md`: ステートマシン設計ワークフロー
